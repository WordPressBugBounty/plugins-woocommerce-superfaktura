/**
 * SuperFaktura - WooCommerce Checkout Block Integration
 *
 * Handles show/hide of company fields based on "Buy as Business client" checkbox.
 */
(function() {
	'use strict';

	// Element IDs generated by WooCommerce Blocks.
	// Format: {location}-{field_id} where "/" in field_id becomes "-".
	const CHECKBOX_ID = 'contact-superfaktura-wi-as-company';
	const FIELD_IDS = [
		'contact-superfaktura-billing-company',
		'contact-superfaktura-billing-company-wi-id',
		'contact-superfaktura-billing-company-wi-vat',
		'contact-superfaktura-billing-company-wi-tax'
	];

	let checkbox = null;
	let fieldContainers = [];
	let initialized = false;

	/**
	 * Find the checkbox element.
	 */
	function findCheckbox() {
		return document.getElementById(CHECKBOX_ID);
	}

	/**
	 * Find field containers.
	 */
	function findFieldContainers() {
		const containers = [];

		for (const fieldId of FIELD_IDS) {
			const input = document.getElementById(fieldId);
			if (input) {
				// Get the parent container (text-input wrapper).
				const container = input.closest('.wc-block-components-text-input');
				if (container) {
					containers.push(container);
				}
			}
		}

		return containers;
	}

	/**
	 * Toggle visibility of company fields.
	 */
	function toggleFields(show) {
		fieldContainers.forEach(function(container) {
			container.style.display = show ? '' : 'none';
		});
	}

	/**
	 * Initialize the toggle functionality.
	 */
	function init() {
		checkbox = findCheckbox();
		if (!checkbox) {
			// Retry after a short delay (React may not have rendered yet).
			setTimeout(init, 300);
			return;
		}

		fieldContainers = findFieldContainers();
		if (fieldContainers.length === 0) {
			// Retry if fields not found yet.
			setTimeout(init, 300);
			return;
		}

		if (initialized) {
			return;
		}
		initialized = true;

		// Set initial state.
		toggleFields(checkbox.checked);

		// Listen for changes.
		checkbox.addEventListener('change', function() {
			toggleFields(this.checked);
		});

		// Observe for React re-renders.
		const observer = new MutationObserver(function() {
			const newCheckbox = findCheckbox();
			const newContainers = findFieldContainers();

			if (newCheckbox && newCheckbox !== checkbox) {
				checkbox = newCheckbox;
				checkbox.addEventListener('change', function() {
					toggleFields(this.checked);
				});
			}

			if (newContainers.length > 0) {
				fieldContainers = newContainers;
				toggleFields(checkbox ? checkbox.checked : false);
			}
		});

		const checkoutForm = document.querySelector('.wc-block-checkout');
		if (checkoutForm) {
			observer.observe(checkoutForm, { childList: true, subtree: true });
		}
	}

	// Start when DOM is ready.
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		setTimeout(init, 100);
	}
})();
